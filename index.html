<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‰åº«ç®¡ç†ç³»çµ±</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            /* --- Morandi Palette --- */
            --bg-app: #F2EFE9;     
            --bg-card: #FFFFFF;    
            --text-main: #5E5A54;  
            --text-light: #9E9991; 
            
            --primary: #8F9EAC;
            --primary-soft: #CFD8DC; 
            --primary-dark: #6d7d8b;
            
            --danger: #C07F7F;
            --success: #8BA38D;
            --warning: #C7B285;
            
            --shadow-soft: 0 2px 10px rgba(94, 90, 84, 0.05); 
            --shadow-hover: 0 8px 20px rgba(94, 90, 84, 0.1);
            --border-subtle: 1px solid #EBE8E1; 
            
            --radius-lg: 16px;
            --radius-md: 12px;
            
            /* Layout Vars */
            --nav-height-mobile: 70px;
            --sidebar-width: 240px;
            --content-max-width: 1100px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            padding-bottom: calc(var(--nav-height-mobile) + 20px); 
        }

        /* --- Layout Structure (PC Optimized) --- */
        .app-layout {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            width: 100%;
            max-width: var(--content-max-width);
            margin: 0 auto;
            padding: 20px;
        }
        
        /* --- Loading Overlay --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(242, 239, 233, 0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.3s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--primary-soft);
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Components --- */
        .neu-card {
            background: var(--bg-card);
            box-shadow: var(--shadow-soft);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            border: var(--border-subtle);
            height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .neu-btn {
            background: var(--primary-soft);
            color: var(--text-main);
            border: none;
            border-radius: 50px;
            font-weight: 600;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.95rem;
        }
        .neu-btn.success, button[type="submit"] { background: var(--primary); color: white; }
        .neu-btn:active { transform: scale(0.98); opacity: 0.9; }
        .neu-btn.danger { background: rgba(192, 127, 127, 0.15); color: var(--danger); }
        .neu-btn.warning { background: rgba(199, 178, 133, 0.15); color: var(--warning); }
        .neu-btn.sm { padding: 6px 14px; font-size: 0.85rem; }
        
        .fab-scan {
            position: fixed;
            bottom: calc(var(--nav-height-mobile) + 20px);
            right: 20px;
            width: 56px; height: 56px;
            background: var(--text-main);
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; z-index: 90; cursor: pointer;
            transition: transform 0.2s;
        }
        .fab-scan:active { transform: scale(0.9); }

        /* Inputs */
        .neu-input, .neu-select, .neu-textarea {
            width: 100%;
            background: #FCFAF8;
            border: 1px solid #DEDAD4;
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-size: 1rem; color: var(--text-main);
            outline: none; margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        .neu-input:focus, .neu-select:focus { border-color: var(--primary); background: white; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }

        /* Image Upload Styles */
        .image-preview-box {
            width: 100%;
            height: 180px;
            border: 2px dashed var(--primary-soft);
            border-radius: var(--radius-md);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #fdfdfd;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .image-preview-box img {
            width: 100%; height: 100%; object-fit: contain;
            display: none;
        }
        .image-preview-box.has-image img { display: block; }
        .image-preview-box.has-image .placeholder { display: none; }
        .image-preview-box input[type="file"] {
            position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }

        /* List Thumbnails */
        .item-thumb {
            width: 60px; height: 60px;
            border-radius: 8px;
            background-color: #eee;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border-subtle);
        }
        .item-thumb-placeholder {
            width: 60px; height: 60px;
            border-radius: 8px;
            background-color: #f0f0f0;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* --- Header & Nav --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        /* Dynamic Header Title */
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 700; display:flex; align-items:center; gap:8px;}

        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 -2px 20px rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
            border-top: var(--border-subtle);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.75rem; color: var(--text-light); background: none; border: none; 
            cursor: pointer; height: 100%; flex: 1;
        }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item.active i { color: var(--primary); weight: bold; }

        /* --- Desktop Media Query --- */
        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            .app-layout { flex-direction: row; }
            .nav-bar {
                position: sticky; top: 0; left: 0;
                width: var(--sidebar-width);
                height: 100vh;
                flex-direction: column;
                justify-content: flex-start;
                padding-top: 40px;
                border-top: none;
                border-right: var(--border-subtle);
                background: white;
            }
            .nav-item { 
                flex: 0; height: 60px; width: 100%; 
                flex-direction: row; justify-content: flex-start; 
                padding-left: 40px; gap: 15px;
                font-size: 1rem;
            }
            .nav-item i { margin-bottom: 0; font-size: 1.4rem; }
            .fab-scan { bottom: 40px; right: 40px; }
            
            #inventory-list-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
            }
            .category-header { grid-column: 1 / -1; margin-top: 30px; }
            
            .item-row { 
                margin-bottom: 0; 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 15px; 
            }
            .item-info-container {
                width: 100%;
                display: flex;
                gap: 15px;
                align-items: flex-start;
            }
            .item-thumb, .item-thumb-placeholder {
                width: 80px; height: 80px; 
            }
            
            .item-row > div:last-child { width: 100%; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 5px; }
        }
        
        @media (max-width: 767px) {
            .item-row {
                display: flex; flex-direction: row; align-items: center; gap: 12px; padding: 12px;
            }
            .item-info-container {
                display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;
            }
            .item-info { min-width: 0; }
            .item-stock-container {
                display: flex; flex-direction: column; align-items: flex-end; min-width: 60px;
            }
        }


        /* --- Inventory List Styles --- */
        .category-header {
            margin-top: 25px; margin-bottom: 12px; padding-left: 12px;
            font-size: 1.1rem; font-weight: 700; color: var(--text-main);
            border-left: 4px solid var(--primary);
            display: flex; align-items: center; justify-content: space-between;
        }
        .item-info h3 { margin: 0 0 4px 0; font-size: 1.05rem; color: var(--text-main); font-weight:600; }
        .stock-number { font-size: 1.6rem; font-weight: 700; color: var(--success); line-height: 1.2; }
        .item-row.low-stock-row .stock-number { color: var(--danger); }
        
        /* --- Type Buttons --- */
        .type-btn { flex: 1; }
        .type-btn.active[data-type="in"] { background: var(--success); color: white; }
        .type-btn.active[data-type="out"] { background: var(--danger); color: white; }
        .type-btn.active[data-type="adj"] { background: var(--warning); color: white; }

        /* --- Settings Chips --- */
        .edit-chip {
            display: inline-flex; align-items: center;
            background: white; border: 1px solid var(--border-subtle);
            border-radius: 20px; overflow: hidden;
            margin: 0 8px 8px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .edit-chip-name {
            padding: 6px 12px; cursor: pointer; font-size: 0.9rem;
            border-right: 1px solid var(--border-subtle);
            display: flex; align-items: center; gap: 4px;
        }
        .edit-chip-name:active { background: #f0f0f0; }
        .edit-chip-del {
            padding: 6px 10px; cursor: pointer; color: var(--danger);
            display: flex; align-items: center; justify-content: center;
        }
        .edit-chip-del:active { background: #fff0f0; }
        
        /* History Items */
        .history-item { border-left: 4px solid transparent; padding: 15px; position: relative;}
        .history-item.type-in { border-left-color: var(--success); }
        .history-item.type-out { border-left-color: var(--danger); }
        .history-item.type-adj { border-left-color: var(--warning); }
        .history-item.voided { opacity: 0.5; filter: grayscale(1); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(94, 90, 84, 0.6);
            backdrop-filter: blur(4px); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; background: var(--bg-card); border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow-hover); }

        /* Utils */
        .hidden { display: none !important; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tag-chip { background: var(--bg-app); border: 1px solid var(--border-subtle); padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; margin-right: 5px; color: var(--text-light); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge.low-stock { background: rgba(192, 127, 127, 0.15); color: var(--danger); }
        .badge.normal { background: rgba(139, 163, 141, 0.15); color: var(--success); }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="color:var(--text-main); font-weight:bold;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
</div>

<div class="app-layout">
    <nav class="nav-bar">
        <div id="sidebar-app-title" style="font-weight:bold; font-size:1.2rem; margin-bottom:20px; color:var(--primary); padding-left:40px; display:none; @media(min-width:768px){display:block;}">
            ğŸ“¦ å€‰åº«ç®¡ç†
        </div>
        <button class="nav-item active" onclick="app.switchTab('view-inventory', this)">
            <i class="ph ph-package"></i><span>åº«å­˜ç¸½è¦½</span>
        </button>
        <button class="nav-item" id="nav-move" onclick="app.switchTab('view-movement', this)">
            <i class="ph ph-arrows-left-right"></i><span>é€²å‡ºä½œæ¥­</span>
        </button>
        <button class="nav-item" onclick="app.switchTab('view-history', this)">
            <i class="ph ph-clock-counter-clockwise"></i><span>æ­·å²ç´€éŒ„</span>
        </button>
        <button class="nav-item" onclick="app.switchTab('view-settings', this)">
            <i class="ph ph-sliders"></i><span>ç³»çµ±è¨­å®š</span>
        </button>
    </nav>

    <main class="main-content">
        <div class="header">
            <h1 id="header-app-title"><i class="ph ph-cloud-check"></i> å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)</h1>
            <button class="neu-btn sm" style="background: white;" onclick="location.reload()">
                <i class="ph ph-arrow-clockwise"></i>
            </button>
        </div>

        <div id="view-inventory" class="view-section">
            <div class="neu-card" style="height: auto;">
                <div style="position: relative;">
                    <i class="ph ph-magnifying-glass" style="position:absolute; left:12px; top:12px; color:var(--text-light)"></i>
                    <input type="text" id="search-input" class="neu-input" style="padding-left: 36px;" placeholder="æœå°‹åç¨±ã€ä»£è™Ÿ..." oninput="app.renderInventory()">
                </div>
                <div class="form-grid">
                    <select id="filter-main-cat" class="neu-select" onchange="app.renderInventory()"></select>
                    <label class="neu-btn sm" style="justify-content:center; background: white; border: var(--border-subtle); color: var(--text-main); margin:0; height: 46px; margin-bottom: 12px;">
                        <input type="checkbox" id="filter-low-stock" onchange="app.renderInventory()" style="margin-right: 8px;"> ç¼ºè²¨ä¸­
                    </label>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; margin-top: 15px;">
                <button class="neu-btn success" onclick="app.openItemModal()">
                    <i class="ph ph-camera-plus"></i> æ–°å¢åŒ…è£
                </button>
            </div>

            <div id="inventory-list-container">
                </div>
        </div>

        <div id="view-movement" class="view-section hidden">
            <div class="neu-card" style="height: auto;">
                <h2 style="color: var(--primary); margin-top:0; display:flex; align-items:center; gap:8px;">
                    <i class="ph ph-note-pencil"></i> é€²å‡ºç´€éŒ„
                </h2>
                <form onsubmit="app.submitMovement(event)">
                    <label>ä½œæ¥­é¡å‹</label>
                    <div style="display:flex; gap: 8px; margin-bottom:15px;">
                        <button type="button" class="neu-btn type-btn active" data-type="in" onclick="app.setMoveType('in')">
                            <i class="ph ph-arrow-down"></i> é€²åº«
                        </button>
                        <button type="button" class="neu-btn type-btn" data-type="out" onclick="app.setMoveType('out')">
                            <i class="ph ph-arrow-up"></i> é ˜å‡º
                        </button>
                        <button type="button" class="neu-btn type-btn" data-type="adj" onclick="app.setMoveType('adj')">
                            <i class="ph ph-wrench"></i> ç›¤é»èª¿æ•´
                        </button>
                    </div>
                    <input type="hidden" id="move-type" value="in">

                    <label>åŒ…è£ç›’</label>
                    <select id="move-item-id" class="neu-select" required onchange="app.updateMoveStockHint()">
                        <option value="">è«‹é¸æ“‡...</option>
                    </select>
                    <div id="move-stock-hint" style="font-size: 0.85rem; color: var(--primary); margin-bottom: 12px; text-align: right; font-weight: 500; height: 20px;"></div>

                    <label id="lbl-qty">æ•¸é‡</label>
                    <input type="number" id="move-qty" class="neu-input" min="0" required placeholder="è¼¸å…¥æ•´æ•¸">

                    <div class="form-grid">
                        <div><label>æ™‚é–“</label><input type="datetime-local" id="move-time" class="neu-input" required></div>
                        <div><label>ç¶“æ‰‹äºº</label><input type="text" id="move-handler" class="neu-input"></div>
                    </div>
                    <label>å‚™è¨»</label>
                    <input type="text" id="move-reason" class="neu-input" placeholder="ä¾‹ï¼šæ¡è³¼ã€å‡ºè²¨...">
                    <button type="submit" class="neu-btn success" style="width: 100%; margin-top: 15px; padding: 12px;">
                        <i class="ph ph-check"></i> ç¢ºèªé€å‡º
                    </button>
                </form>
            </div>
        </div>

        <div id="view-history" class="view-section hidden">
            <div class="neu-card" style="height: auto;">
                <div class="form-grid">
                    <div><label>é–‹å§‹</label><input type="date" id="hist-start" class="neu-input" onchange="app.renderHistory()"></div>
                    <div><label>çµæŸ</label><input type="date" id="hist-end" class="neu-input" onchange="app.renderHistory()"></div>
                </div>
                <input type="text" id="hist-search" class="neu-input" placeholder="æœå°‹é—œéµå­—..." oninput="app.renderHistory()" style="margin-top: 10px;">
            </div>
            <div id="history-list" style="margin-top: 20px;"></div>
        </div>

        <div id="view-settings" class="view-section hidden">
            <div class="neu-card" style="height: auto;">
                <h2 style="color: var(--primary); margin-top:0; display:flex; align-items:center; gap:8px;">
                    <i class="ph ph-sliders"></i> ç³»çµ±è¨­å®š
                </h2>
                
                <div class="neu-card" style="background: #F8F9FA; border:none; padding: 15px; box-shadow:none; height:auto; margin-bottom:15px;">
                    <h3 style="margin-top:0; font-size:1rem; color:var(--text-main)">ç³»çµ±åç¨± (æ¨™é¡Œ)</h3>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="setting-app-title" class="neu-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„å€‰åº«ç®¡ç†" style="margin:0;">
                        <button class="neu-btn sm success" onclick="app.saveAppTitle()">å„²å­˜åç¨±</button>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-light); margin:5px 0 0 0;">ä¿®æ”¹å¾Œå°‡å³æ™‚åŒæ­¥è‡³æ‰€æœ‰è£ç½®</p>
                </div>

                <h2 style="color: var(--primary); margin-top:10px; display:flex; align-items:center; gap:8px;">
                    <i class="ph ph-tag"></i> åˆ†é¡ç®¡ç†
                </h2>
                <p style="font-size:0.8rem; color:var(--text-light); margin-top:-10px; margin-bottom:15px;">é»æ“Šåç¨±å¯ä¿®æ”¹ï¼Œé»æ“Š âœ• åˆªé™¤</p>

                <div class="neu-card" style="background: #F8F9FA; border:none; padding: 15px; box-shadow:none; height:auto;">
                    <h3 style="margin-top:0; font-size:1rem; color:var(--text-main)">å¤§é¡</h3>
                    <div id="settings-main-cat-list" style="margin-bottom: 12px;"></div>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="new-main-cat" class="neu-input" placeholder="æ–°å¤§é¡åç¨±" style="margin:0;">
                        <button class="neu-btn sm success" onclick="app.addMainCat()"><i class="ph ph-plus"></i></button>
                    </div>
                </div>

                <div class="neu-card" style="background: #F8F9FA; border:none; padding: 15px; box-shadow:none; margin-top:15px; height:auto;">
                    <h3 style="margin-top:0; font-size:1rem; color:var(--text-main)">å°é¡</h3>
                    <select id="settings-sub-cat-parent" class="neu-select" style="margin-bottom:10px;">
                        <option value="">å…ˆé¸æ“‡å¤§é¡...</option>
                    </select>
                    <div id="settings-sub-cat-list" style="margin-bottom: 12px;"></div>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="new-sub-cat" class="neu-input" placeholder="æ–°å°é¡åç¨±" style="margin:0;">
                        <button class="neu-btn sm success" onclick="app.addSubCat()"><i class="ph ph-plus"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="neu-card" style="border-color: var(--danger); height:auto; margin-top:20px;">
                <button class="neu-btn danger" style="width:100%;" onclick="app.clearAllData()">
                    <i class="ph ph-trash"></i> æ¸…ç©ºæ‰€æœ‰è³‡æ–™ (é›²ç«¯)
                </button>
            </div>

            <div class="neu-card" style="border: 2px dashed var(--primary-soft); text-align: center; cursor: pointer; height:auto; margin-top:20px;" onclick="app.openBackupModal()">
                <h3 style="color:var(--primary); margin:0; font-size:1.1rem; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <i class="ph ph-download-simple"></i> è³‡æ–™å‚™ä»½èˆ‡åŒ¯å…¥
                </h3>
            </div>
        </div>
    </main>
</div>

<div class="fab-scan" onclick="app.openScanner()">
    <i class="ph ph-scan"></i>
</div>

<div id="modal-scanner" class="modal-overlay">
    <div class="neu-card modal-content" style="text-align:center; height:auto;">
        <h3 style="color:var(--text-main); margin-top:0;">æƒææ¢ç¢¼</h3>
        <div id="reader" style="width: 100%; border-radius:12px; overflow:hidden;"></div>
        <p style="font-size:0.85rem; color:var(--text-light); margin:15px 0;">å°æº–åŒ…è£ä¸Šçš„åœ‹éš›æ¢ç¢¼<br>ç³»çµ±å°‡è‡ªå‹•æœå°‹ä»£è™Ÿ</p>
        <button class="neu-btn danger" onclick="app.closeScanner()">é—œé–‰</button>
    </div>
</div>

<div id="modal-item" class="modal-overlay">
    <div class="neu-card modal-content">
        <h2 id="modal-item-title" style="color: var(--primary); margin-top:0;">æ–°å¢åŒ…è£</h2>
        <form onsubmit="app.saveItem(event)">
            <input type="hidden" id="item-id">
            
            <label>åŒ…è£åœ–ç‰‡ (é»æ“Šä¸Šå‚³)</label>
            <div class="image-preview-box" onclick="document.getElementById('item-image-file').click()">
                <div class="placeholder" style="text-align:center; color:var(--text-light)">
                    <i class="ph ph-camera" style="font-size:2rem; margin-bottom:5px;"></i><br>
                    <span>é¸æ“‡ç…§ç‰‡</span>
                </div>
                <img id="item-image-preview" src="">
                <input type="file" id="item-image-file" accept="image/*" onchange="app.handleImageUpload(this)">
                <input type="hidden" id="item-image-base64"> </div>
            
            <label>åç¨± *</label>
            <input type="text" id="item-name" class="neu-input" required>
            <label>æ¢ç¢¼ / ä»£è™Ÿ</label>
            <input type="text" id="item-code" class="neu-input" placeholder="æƒææ™‚è¾¨è­˜ç”¨">
            
            <div class="form-grid">
                <div>
                    <label>å¤§é¡ *</label>
                    <select id="item-main-cat" class="neu-select" required onchange="app.renderSubCatOptionsInModal()"></select>
                </div>
                <div>
                    <label>å°é¡</label>
                    <select id="item-sub-cat" class="neu-select"></select>
                </div>
            </div>
            <div class="form-grid">
                <div><label>å®‰å…¨åº«å­˜</label><input type="number" id="item-safety" class="neu-input" value="0"></div>
                <div><label>æ¨™ç±¤</label><input type="text" id="item-tags" class="neu-input"></div>
            </div>
            <label>å‚™è¨»</label>
            <textarea id="item-notes" class="neu-textarea" rows="2"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button type="button" class="neu-btn" onclick="app.closeModals()">å–æ¶ˆ</button>
                <button type="submit" class="neu-btn success">å„²å­˜ (åŒæ­¥é›²ç«¯)</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-detail" class="modal-overlay">
    <div class="neu-card modal-content">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <h2 id="detail-title" style="color:var(--primary); margin-top:0; margin-bottom:10px;"></h2>
            <button class="neu-btn sm" onclick="app.closeModals()" style="background:none; color:var(--text-light); padding:0;">âœ•</button>
        </div>
        
        <div id="detail-image-container" style="text-align:center; margin-bottom:15px; display:none;">
            <img id="detail-image" src="" style="max-width:100%; max-height:250px; border-radius:12px; border:1px solid #eee;">
        </div>

        <div id="detail-stats" style="margin-bottom:20px; padding:15px; background:var(--bg-app); border-radius:var(--radius-md); font-size: 0.9rem; line-height:1.6;"></div>
        <h3 style="font-size:1rem; color:var(--text-light)">è¿‘æœŸç´€éŒ„</h3>
        <div id="detail-ledger" style="max-height: 250px; overflow-y: auto;"></div>
        
        <div style="display:flex; justify-content:space-between; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
             <button class="neu-btn danger sm" id="btn-delete-item" onclick="">
                <i class="ph ph-trash"></i> åˆªé™¤
             </button>
             <div style="display:flex; gap:10px;">
                 <button class="neu-btn sm" style="background:var(--primary-soft); color:var(--text-main)" id="btn-edit-item" onclick="">
                    <i class="ph ph-pencil-simple"></i> ä¿®æ”¹
                 </button>
                 <button class="neu-btn sm success" onclick="app.closeModals()">
                    é—œé–‰
                 </button>
             </div>
        </div>
    </div>
</div>

<div id="modal-backup" class="modal-overlay">
    <div class="neu-card modal-content" style="height:auto;">
        <h2 style="color:var(--primary); margin-top:0;">è³‡æ–™ç®¡ç†</h2>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <button class="neu-btn" onclick="app.exportData()">
                <i class="ph ph-export"></i> åŒ¯å‡ºå‚™ä»½ (JSON)
            </button>
            <div style="border-top:1px solid var(--border-subtle);"></div>
            <label>åŒ¯å…¥å‚™ä»½ (å°‡è¦†è“‹ç¾æœ‰è³‡æ–™)</label>
            <input type="file" id="import-file" class="neu-input">
            <button class="neu-btn warning" onclick="app.importData()">
                <i class="ph ph-upload"></i> ç¢ºèªåŒ¯å…¥
            </button>
        </div>
        <button class="neu-btn" style="margin-top:20px; width:100%;" onclick="app.closeModals()">é—œé–‰</button>
    </div>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB8QiVjk-PRxre7xlt389vs0Hf5aBiAXrg",
    authDomain: "my-erp-system-6521c.firebaseapp.com",
    projectId: "my-erp-system-6521c",
    storageBucket: "my-erp-system-6521c.firebasestorage.app",
    messagingSenderId: "374424194868",
    appId: "1:374424194868:web:521879509c985ca0dd1f61",
    measurementId: "G-EQDX9HSNMX"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // Bind to window for global access
  window.db = db;
  window.doc = doc;
  window.onSnapshot = onSnapshot;
  window.setDoc = setDoc;
  
  // Dispatch event
  window.dispatchEvent(new Event('firebase-ready'));
</script>

<script>
    const App = function() {
        // Default structure + appTitle
        this.data = { appTitle: 'å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)', items: [], movements: [], categories: { main: [], sub: [] } };
        
        this.docRef = null; 
        this.html5QrcodeScanner = null;
        this.unsubscribe = null;

        this.init = () => {
            // Wait for Firebase
            if (window.db) {
                this.setupRealtimeSync();
            } else {
                window.addEventListener('firebase-ready', () => this.setupRealtimeSync());
            }
            
            // Set default time
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('move-time').value = now.toISOString().slice(0, 16);
        };

        // --- REAL-TIME SYNC ---
        this.setupRealtimeSync = () => {
            console.log("Connecting to Cloud...");
            this.docRef = window.doc(window.db, "inventory", "main_data");

            // Listen
            this.unsubscribe = window.onSnapshot(this.docRef, (docSnap) => {
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(()=>document.getElementById('loading-overlay').style.display='none', 300);

                if (docSnap.exists()) {
                    this.data = docSnap.data();
                    this.renderAll();
                } else {
                    this.seedDemoData();
                }
            }, (error) => {
                alert("é€£ç·šéŒ¯èª¤ï¼šè«‹ç¢ºèª Firebase Firestore æ¬Šé™ã€‚");
                document.getElementById('loading-overlay').style.display='none';
            });
        };

        // Upload
        this.saveData = async () => {
            try {
                await window.setDoc(this.docRef, this.data);
            } catch (e) {
                alert("å„²å­˜å¤±æ•—ï¼š"+e.message);
            }
        };

        this.seedDemoData = () => {
            const teaId = 'c1', boxId = 'c2';
            this.data.categories.main = [{id:teaId, name:'èŒ¶ç¦®ç›’'}, {id:boxId, name:'å¤–ç®±'}];
            this.data.categories.sub = [{id:'s1', parentId:teaId, name:'å››å…©'}];
            this.data.items = [
                { id: 'i1', name: 'ç´…ç‰å››å…©ç›’', code: '4711234567890', mainCatId: teaId, subCatId: 's1', tags: 'ç†±éŠ·', safetyStock: 30, notes: '', image: '' }
            ];
            this.data.movements = [{ id: 'm1', itemId: 'i1', type: 'in', qty: 100, time: new Date().toISOString(), handler: 'åˆå§‹', reason: '', isVoid: false }];
            this.saveData(); 
        };

        // --- Data Logic ---
        this.getStock = (itemId) => {
            return this.data.movements.reduce((acc, m) => {
                if (m.itemId !== itemId || m.isVoid) return acc;
                return acc + (m.type === 'in' ? m.qty : (m.type === 'out' ? -m.qty : m.qty));
            }, 0);
        };
        this.getItem = (id) => this.data.items.find(i => i.id === id);
        this.getMainCatName = (id) => (this.data.categories.main.find(x=>x.id==id) || {}).name || 'æœªåˆ†é¡';
        this.getSubCatName = (id) => (this.data.categories.sub.find(x=>x.id==id) || {}).name || '';

        // --- View Logic ---
        this.renderAll = () => {
            // Update Title
            const title = this.data.appTitle || 'å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)';
            document.title = title;
            document.getElementById('header-app-title').innerHTML = `<i class="ph ph-cloud-check"></i> ${title}`;
            document.getElementById('sidebar-app-title').innerHTML = `ğŸ“¦ ${title}`;
            
            this.renderInventory();
            this.renderMoveSelect();
            this.renderHistory();
            this.renderSettings();
        };

        this.switchTab = (tabId, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(tabId === 'view-inventory') this.renderInventory();
            window.scrollTo(0,0);
        };

        // ... Inventory Render ...
        this.renderInventory = () => {
            const container = document.getElementById('inventory-list-container');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterMain = document.getElementById('filter-main-cat').value;
            const onlyLow = document.getElementById('filter-low-stock').checked;
            container.innerHTML = '';
            
            const grouped = {};
            this.data.categories.main.forEach(c => grouped[c.id] = {name:c.name, items:[]});
            grouped['uncat'] = {name:'æœªåˆ†é¡', items:[]};

            this.data.items.forEach(item => {
                const stock = this.getStock(item.id);
                const isLow = item.safetyStock > 0 && stock <= item.safetyStock;
                if (onlyLow && !isLow) return;
                if (filterMain && item.mainCatId !== filterMain) return;
                if (search && !(item.name+item.code+item.tags).toLowerCase().includes(search)) return;
                const k = (item.mainCatId && grouped[item.mainCatId]) ? item.mainCatId : 'uncat';
                grouped[k].items.push({...item, stock, isLow});
            });

            Object.keys(grouped).forEach(k => {
                if (grouped[k].items.length === 0) return;
                container.innerHTML += `<div class="category-header"><span>${grouped[k].name}</span><span style="font-weight:normal; font-size:0.8rem; color:var(--text-light)">${grouped[k].items.length}</span></div>`;
                grouped[k].items.sort((a,b)=>a.name.localeCompare(b.name)).forEach(i => {
                    const sub = this.getSubCatName(i.subCatId);
                    const imgHtml = i.image ? `<img src="${i.image}" class="item-thumb" loading="lazy">` : `<div class="item-thumb-placeholder"><i class="ph ph-package"></i></div>`;
                    container.innerHTML += `
                    <div class="neu-card item-row ${i.isLow?'low-stock-row':''}" onclick="app.openDetail('${i.id}')">
                        <div class="item-info-container">
                            ${imgHtml}
                            <div class="item-info">
                                <h3>${i.name} <span style="font-size:0.8rem;color:var(--primary)">${sub?'Â· '+sub:''}</span></h3>
                                <div style="font-size:0.85rem; color:var(--text-light)">${i.code?`<i class="ph ph-barcode"></i> ${i.code} | `:''}å®‰å…¨: ${i.safetyStock}</div>
                            </div>
                        </div>
                        <div class="item-stock-container">
                            <span class="stock-number">${i.stock}</span>
                            <span class="badge ${i.isLow?'low-stock':'normal'}">${i.isLow?'è£œè²¨':'æ­£å¸¸'}</span>
                        </div>
                    </div>`;
                });
            });
        };

        // ... Settings Render (Updated) ...
        this.renderSettings = () => {
            // Title Setting
            document.getElementById('setting-app-title').value = this.data.appTitle || '';

            // Categories
            document.getElementById('settings-main-cat-list').innerHTML = this.data.categories.main.map(c=>`<div class="edit-chip"><span class="edit-chip-name" onclick="app.editMainCat('${c.id}')">${c.name}</span><span class="edit-chip-del" onclick="app.delMain('${c.id}')">âœ•</span></div>`).join('');
            const pSel = document.getElementById('settings-sub-cat-parent'); 
            const currentP = pSel.value;
            pSel.innerHTML = '<option value="">å…ˆé¸å¤§é¡...</option>'+this.data.categories.main.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            pSel.value = currentP; // keep selection
            
            document.getElementById('filter-main-cat').innerHTML = '<option value="">æ‰€æœ‰å¤§é¡</option>'+this.data.categories.main.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            
            this.renderSubSettings();
        };
        
        // Save App Title
        this.saveAppTitle = () => {
            const t = document.getElementById('setting-app-title').value;
            if(t) {
                this.data.appTitle = t;
                this.saveData();
                alert('ç³»çµ±åç¨±å·²æ›´æ–°ï¼');
            }
        };

        // ... Other existing functions ...
        this.renderSubSettings = () => {
            const pid = document.getElementById('settings-sub-cat-parent').value;
            const subs = this.data.categories.sub.filter(s=>s.parentId===pid);
            document.getElementById('settings-sub-cat-list').innerHTML = subs.map(s=>`<div class="edit-chip"><span class="edit-chip-name" onclick="app.editSubCat('${s.id}')">${s.name}</span><span class="edit-chip-del" onclick="app.delSub('${s.id}')">âœ•</span></div>`).join('');
        };
        document.getElementById('settings-sub-cat-parent').onchange = () => app.renderSubSettings();
        
        this.addMainCat=()=>{const n=document.getElementById('new-main-cat').value; if(n){this.data.categories.main.push({id:'mc'+Date.now(),name:n}); document.getElementById('new-main-cat').value=''; this.saveData();}};
        this.editMainCat=(id)=>{const c=this.data.categories.main.find(x=>x.id==id);const n=prompt('ä¿®æ”¹',c.name);if(n){c.name=n;this.saveData();}};
        this.delMain=(id)=>{if(confirm('ç¢ºå®šï¼Ÿ')){this.data.categories.main=this.data.categories.main.filter(x=>x.id!==id);this.saveData();}};
        this.addSubCat=()=>{const p=document.getElementById('settings-sub-cat-parent').value, n=document.getElementById('new-sub-cat').value; if(p&&n){this.data.categories.sub.push({id:'sc'+Date.now(),parentId:p,name:n}); document.getElementById('new-sub-cat').value=''; this.saveData();}};
        this.editSubCat=(id)=>{const c=this.data.categories.sub.find(x=>x.id==id);const n=prompt('ä¿®æ”¹',c.name);if(n){c.name=n;this.saveData();}};
        this.delSub=(id)=>{if(confirm('ç¢ºå®šï¼Ÿ')){this.data.categories.sub=this.data.categories.sub.filter(x=>x.id!==id);this.saveData();}};
        this.clearAllData=()=>{if(confirm('è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºé›²ç«¯è³‡æ–™åº«ï¼')){this.data={appTitle:this.data.appTitle, items:[],movements:[],categories:{main:[],sub:[]}};this.saveData();}};

        this.setMoveType = (t) => {
            document.getElementById('move-type').value = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.type-btn[data-type="${t}"]`).classList.add('active');
            const qtyLabel = document.getElementById('lbl-qty');
            if(t==='adj') { qtyLabel.innerHTML="ç›¤é»å¾Œæ­£ç¢ºæ•¸é‡"; qtyLabel.style.color="var(--warning)"; } 
            else { qtyLabel.innerHTML="æ•¸é‡"; qtyLabel.style.color="var(--text-main)"; }
        };
        this.renderMoveSelect = () => {
            const sel = document.getElementById('move-item-id');
            const curr = sel.value; sel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            this.data.items.sort((a,b) => (this.getMainCatName(a.mainCatId)+a.name).localeCompare(this.getMainCatName(b.mainCatId)+b.name))
                .forEach(i => sel.innerHTML += `<option value="${i.id}" data-stock="${this.getStock(i.id)}">[${this.getMainCatName(i.mainCatId)}] ${i.name}</option>`);
            sel.value = curr; 
        };
        this.updateMoveStockHint = () => {
            const opt = document.getElementById('move-item-id').selectedOptions[0];
            document.getElementById('move-stock-hint').textContent = opt && opt.value ? `åº«å­˜: ${opt.dataset.stock}` : '';
        };
        this.submitMovement = (e) => {
            e.preventDefault();
            const type = document.getElementById('move-type').value;
            const itemId = document.getElementById('move-item-id').value;
            const qty = parseInt(document.getElementById('move-qty').value);
            const stock = this.getStock(itemId);
            const reason = document.getElementById('move-reason').value;
            if (!itemId || isNaN(qty) || qty < 0) return alert('è«‹å¡«å¯«æ­£ç¢º');
            let finalQty = qty, finalReason = reason;
            if (type === 'out' && stock < qty) return alert('åº«å­˜ä¸è¶³');
            if (type === 'adj') {
                const diff = qty - stock;
                if(diff === 0) return alert('åº«å­˜ç„¡è®Šå‹•');
                finalQty = diff; finalReason = `ç›¤é»ä¿®æ­£ (${stock}â”${qty}) ` + reason;
            }
            this.data.movements.push({id:'m_'+Date.now(), itemId, type, qty:finalQty, time:document.getElementById('move-time').value, handler:document.getElementById('move-handler').value, reason:finalReason, isVoid:false});
            this.saveData(); alert('å·²å„²å­˜'); e.target.reset(); this.setMoveType('in');
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('move-time').value = now.toISOString().slice(0, 16);
        };

        this.openScanner=()=>{document.getElementById('modal-scanner').classList.add('open');if(!this.html5QrcodeScanner){const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0, videoConstraints: { facingMode: "environment" } }; this.html5QrcodeScanner=new Html5QrcodeScanner("reader",config);this.html5QrcodeScanner.render((txt)=>{const item=this.data.items.find(i=>i.code===txt);if(item){this.closeScanner();this.switchTab('view-movement',document.getElementById('nav-move'));const sel=document.getElementById('move-item-id');sel.value=item.id;this.updateMoveStockHint();setTimeout(()=>{alert(`å·²æƒæï¼š${item.name}\nåº«å­˜ï¼š${this.getStock(item.id)}`);document.getElementById('move-qty').focus();},300);}else{this.html5QrcodeScanner.pause();alert('æ‰¾ä¸åˆ°æ¢ç¢¼ï¼š'+txt);this.html5QrcodeScanner.resume();}},(err)=>{});}};
        this.closeScanner=()=>{document.getElementById('modal-scanner').classList.remove('open');if(this.html5QrcodeScanner){this.html5QrcodeScanner.clear().then(_=>{this.html5QrcodeScanner=null;document.getElementById('reader').innerHTML="";}).catch(e=>{});}};
        
        this.handleImageUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas'); const mw = 600; const sc = mw/img.width;
                    const w = (img.width>mw)?mw:img.width; const h = (img.width>mw)?img.height*sc:img.height;
                    cvs.width=w; cvs.height=h; const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
                    const url = cvs.toDataURL('image/jpeg',0.6);
                    document.getElementById('item-image-preview').src = url;
                    document.querySelector('.image-preview-box').classList.add('has-image');
                    document.getElementById('item-image-base64').value = url;
                };
            };
        };

        this.openItemModal = (id=null) => {
            document.getElementById('modal-item').classList.add('open');
            document.getElementById('item-main-cat').innerHTML = '<option value="">é¸...</option>'+this.data.categories.main.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            const imgBox = document.querySelector('.image-preview-box');
            if(id) {
                const i = this.getItem(id);
                document.getElementById('modal-item-title').innerText="ä¿®æ”¹åŒ…è£";
                document.getElementById('item-id').value=i.id; document.getElementById('item-name').value=i.name; document.getElementById('item-code').value=i.code||'';
                document.getElementById('item-main-cat').value=i.mainCatId; this.renderSubCatOptionsInModal(); document.getElementById('item-sub-cat').value=i.subCatId;
                document.getElementById('item-safety').value=i.safetyStock; document.getElementById('item-tags').value=i.tags; document.getElementById('item-notes').value=i.notes;
                document.getElementById('item-image-base64').value=i.image||'';
                document.getElementById('item-image-preview').src=i.image||'';
                if(i.image) imgBox.classList.add('has-image'); else imgBox.classList.remove('has-image');
            } else {
                document.getElementById('modal-item-title').innerText="æ–°å¢åŒ…è£"; document.getElementById('item-id').value=''; document.querySelector('#modal-item form').reset();
                imgBox.classList.remove('has-image');
            }
        };
        this.renderSubCatOptionsInModal = () => {
            const pid = document.getElementById('item-main-cat').value;
            document.getElementById('item-sub-cat').innerHTML = '<option value="">ç„¡</option>' + this.data.categories.sub.filter(s=>s.parentId===pid).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        };
        this.saveItem = (e) => {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const obj = {
                id: id?id:'i_'+Date.now(), name:document.getElementById('item-name').value, code:document.getElementById('item-code').value,
                mainCatId:document.getElementById('item-main-cat').value, subCatId:document.getElementById('item-sub-cat').value,
                safetyStock:document.getElementById('item-safety').value, tags:document.getElementById('item-tags').value,
                notes:document.getElementById('item-notes').value, image:document.getElementById('item-image-base64').value
            };
            if(id){ const idx=this.data.items.findIndex(x=>x.id===id); if(idx!==-1)this.data.items[idx]=obj; }
            else { this.data.items.push(obj); }
            this.saveData(); this.closeModals();
        };
        this.deleteItem = (id) => {
            if(confirm('åˆªé™¤åŒ…è£æœƒé€£åŒæ­·å²ç´€éŒ„ä¸€ä½µåˆªé™¤ï¼Œç¢ºå®šï¼Ÿ')){
                this.data.items = this.data.items.filter(i=>i.id!==id);
                this.data.movements = this.data.movements.filter(m=>m.itemId!==id);
                this.saveData(); this.closeModals();
            }
        };
        this.openDetail = (id) => {
            const item = this.getItem(id);
            document.getElementById('modal-detail').classList.add('open');
            document.getElementById('detail-title').innerText = item.name;
            const imgContainer = document.getElementById('detail-image-container');
            if(item.image) { document.getElementById('detail-image').src = item.image; imgContainer.style.display='block'; } else imgContainer.style.display='none';
            let bal = 0, html = '<table style="width:100%;font-size:0.9rem"><tr><td>æ™‚é–“</td><td>å‹•ä½œ</td><td align="right">è®Š</td><td align="right">é¤˜</td></tr>';
            this.data.movements.filter(m=>m.itemId===id && !m.isVoid).sort((a,b)=>new Date(a.time)-new Date(b.time)).forEach(m=>{
                const chg = m.type==='in'?m.qty:(m.type==='out'?-m.qty:m.qty); bal+=chg;
                html+=`<tr><td style="border-top:1px solid #eee;padding:8px 0">${m.time.substring(5,16).replace('T',' ')}</td><td>${m.type}</td><td align="right" style="color:${chg>0?'green':'red'}">${chg>0?'+'+chg:chg}</td><td align="right"><b>${bal}</b></td></tr>`;
            });
            document.getElementById('detail-ledger').innerHTML=html+'</table>';
            document.getElementById('detail-stats').innerHTML=`æ¢ç¢¼: ${item.code||'--'}<br>åº«å­˜: ${bal} / å®‰å…¨: ${item.safetyStock}<br>åˆ†é¡: ${this.getMainCatName(item.mainCatId)}`;
            
            document.getElementById('btn-delete-item').onclick = () => app.deleteItem(id);
            document.getElementById('btn-edit-item').onclick = () => { app.closeModals(); setTimeout(()=>app.openItemModal(id),200); };
        };
        this.openBackupModal = () => document.getElementById('modal-backup').classList.add('open');
        this.exportData = () => {
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
            a.download = "inventory_backup.json"; a.click();
        };
        this.importData = () => {
            const f = document.getElementById('import-file').files[0]; if(!f) return;
            const r = new FileReader(); r.onload = e => { if(confirm('è¦†è“‹ï¼Ÿ')) { this.data = JSON.parse(e.target.result); this.saveData(); }};
            r.readAsText(f);
        };
        this.closeModals=()=>{document.querySelectorAll('.modal-overlay').forEach(el=>el.classList.remove('open'));this.closeScanner();};
    };

    const app = new App();
    window.onload = () => app.init();
    document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) app.closeModals(); }));
</script>
</body>
</html>
