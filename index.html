<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-app: #F2EFE9;      
            --bg-card: #FFFFFF;     
            --text-main: #5E5A54;   
            --text-light: #9E9991; 
            --primary: #8F9EAC;
            --primary-soft: #CFD8DC; 
            --danger: #C07F7F;
            --success: #8BA38D;
            --warning: #C7B285;
            --border-subtle: 1px solid #EBE8E1; 
            --radius-lg: 16px;
            --radius-md: 12px;
            --nav-height-mobile: 70px;
            --sidebar-width: 240px;
            --content-max-width: 1100px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            padding-bottom: calc(var(--nav-height-mobile) + 20px); 
        }

        /* --- Layout --- */
        .app-layout { display: flex; min-height: 100vh; flex-direction: column; }
        .main-content { flex: 1; width: 100%; max-width: var(--content-max-width); margin: 0 auto; padding: 20px; }
        
        /* --- Loading Overlay --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(242, 239, 233, 0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.3s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--primary-soft);
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Components --- */
        .neu-card {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: 20px; margin-bottom: 20px; border: var(--border-subtle);
            box-shadow: 0 2px 10px rgba(94, 90, 84, 0.05);
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .neu-btn {
            background: var(--primary-soft); color: var(--text-main); border: none;
            border-radius: 50px; font-weight: 600; padding: 10px 20px;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.95rem; transition: transform 0.1s;
        }
        .neu-btn:active { transform: scale(0.96); }
        .neu-btn.success { background: var(--primary); color: white; }
        .neu-btn.danger { background: rgba(192, 127, 127, 0.15); color: var(--danger); }
        .neu-btn.warning { background: rgba(199, 178, 133, 0.15); color: var(--warning); }
        .neu-btn.sm { padding: 6px 14px; font-size: 0.85rem; }
        
        /* å›ºå®šé«˜åº¦ä»¥ç¢ºä¿å°é½Š */
        .neu-input, .neu-select {
            width: 100%; background: #FCFAF8; border: 1px solid #DEDAD4;
            border-radius: var(--radius-md); padding: 0 16px; font-size: 1rem;
            outline: none; margin-bottom: 12px;
            height: 48px; 
            line-height: 48px;
        }
        .neu-textarea {
            width: 100%; background: #FCFAF8; border: 1px solid #DEDAD4;
            border-radius: var(--radius-md); padding: 12px 16px; font-size: 1rem;
            outline: none; margin-bottom: 12px;
        }
        
        .neu-input:focus { border-color: var(--primary); background: white; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }

        /* --- Images --- */
        .image-preview-box {
            width: 100%; height: 180px; border: 2px dashed var(--primary-soft);
            border-radius: var(--radius-md); display: flex; justify-content: center; align-items: center;
            background: #fdfdfd; margin-bottom: 15px; position: relative; overflow: hidden; cursor: pointer;
        }
        .image-preview-box img { width: 100%; height: 100%; object-fit: contain; display: none; }
        .image-preview-box.has-image img { display: block; }
        .image-preview-box.has-image .placeholder { display: none; }
        .item-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-subtle); flex-shrink: 0; }
        .item-thumb-placeholder { width: 60px; height: 60px; border-radius: 8px; background: #eee; display:flex; align-items:center; justify-content:center; color:#aaa; font-size:1.5rem; flex-shrink: 0; }

        /* --- Responsive --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 700; display:flex; align-items:center; gap:8px;}
        
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile);
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-top: var(--border-subtle); display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; color: var(--text-light); background:none; border:none; cursor: pointer; flex:1; height:100%; justify-content:center;}
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; }

        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            .app-layout { flex-direction: row; }
            .nav-bar {
                position: sticky; top: 0; left: 0; width: var(--sidebar-width); height: 100vh;
                flex-direction: column; justify-content: flex-start; padding-top: 40px; border-top: none; border-right: var(--border-subtle);
            }
            .nav-item { flex: 0; height: 60px; width: 100%; flex-direction: row; justify-content: flex-start; padding-left: 40px; gap: 15px; font-size: 1rem; }
            .nav-item i { margin-bottom: 0; font-size: 1.4rem; }
            #inventory-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
            .category-header { grid-column: 1 / -1; margin-top: 30px; }
            .item-row { flex-direction: column; align-items: flex-start; gap: 15px; }
            .item-row > div:first-child { width: 100%; display: flex; gap: 15px; }
            .item-row > div:last-child { width: 100%; display: flex; justify-content: space-between; border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 5px; }
            .fab-scan { bottom: 40px; right: 40px; }
        }

        @media (max-width: 767px) {
            .item-row { display: flex; align-items: center; gap: 12px; }
            .item-info-container { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
            .item-stock-container { display: flex; flex-direction: column; align-items: flex-end; min-width: 60px; }
        }

        /* --- Misc --- */
        .category-header { margin-top: 25px; margin-bottom: 12px; padding-left: 12px; font-size: 1.1rem; font-weight: 700; color: var(--text-main); border-left: 4px solid var(--primary); display: flex; justify-content: space-between; }
        .stock-number { font-size: 1.6rem; font-weight: 700; color: var(--success); }
        .low-stock-row .stock-number { color: var(--danger); }
        .tag-chip { background: var(--bg-app); border: 1px solid var(--border-subtle); padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; margin-right: 5px; color: var(--text-light); }
        .type-btn { flex: 1; }
        .type-btn.active[data-type="in"] { background: var(--success); color: white; }
        .type-btn.active[data-type="out"] { background: var(--danger); color: white; }
        .type-btn.active[data-type="adj"] { background: var(--warning); color: white; }
        
        .fab-scan { position: fixed; bottom: calc(var(--nav-height-mobile) + 20px); right: 20px; width: 56px; height: 56px; background: var(--text-main); color: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 90; cursor: pointer; }
        .fab-scan:active { transform: scale(0.9); }

        .hidden { display: none !important; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(94, 90, 84, 0.6); backdrop-filter: blur(4px); z-index: 200; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; background: var(--bg-card); border-radius: var(--radius-lg); padding: 25px; }

        /* Settings Chips */
        .edit-chip { display: inline-flex; background: white; border: 1px solid var(--border-subtle); border-radius: 20px; margin: 0 8px 8px 0; overflow:hidden; }
        .edit-chip-name { padding: 6px 12px; cursor: pointer; font-size: 0.9rem; border-right: 1px solid var(--border-subtle); }
        .edit-chip-del { padding: 6px 10px; cursor: pointer; color: var(--danger); display: flex; align-items:center; }
        
        .history-item { border-left: 4px solid #ccc; padding: 15px; }
        .history-item.type-in { border-left-color: var(--success); }
        .history-item.type-out { border-left-color: var(--danger); }
        .history-item.type-adj { border-left-color: var(--warning); }
        .history-item.voided { opacity: 0.5; filter: grayscale(1); }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="color:var(--text-main); font-weight:bold;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
</div>

<div class="app-layout">
    <nav class="nav-bar">
        <div id="nav-title-text" style="font-weight:bold; font-size:1.2rem; margin-bottom:20px; color:var(--primary); padding-left:40px; display:none; @media(min-width:768px){display:block;}">
            ğŸ“¦ å€‰åº«ç®¡ç†
        </div>
        <button class="nav-item active" onclick="app.switchTab('view-inventory', this)"><i class="ph ph-package"></i><span>åº«å­˜</span></button>
        <button class="nav-item" id="nav-move" onclick="app.switchTab('view-movement', this)"><i class="ph ph-arrows-left-right"></i><span>é€²å‡º</span></button>
        <button class="nav-item" onclick="app.switchTab('view-history', this)"><i class="ph ph-clock-counter-clockwise"></i><span>ç´€éŒ„</span></button>
        <button class="nav-item" onclick="app.switchTab('view-settings', this)"><i class="ph ph-sliders"></i><span>è¨­å®š</span></button>
    </nav>

    <main class="main-content">
        <div class="header">
            <h1><i class="ph ph-cloud-check"></i> <span id="header-title-text">å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)</span></h1>
            <button class="neu-btn sm" style="background: white;" onclick="location.reload()"><i class="ph ph-arrow-clockwise"></i></button>
        </div>

        <div id="view-inventory" class="view-section">
            <div class="neu-card" style="height: auto;">
                <div style="position: relative;">
                    <i class="ph ph-magnifying-glass" style="position:absolute; left:12px; top:12px; color:var(--text-light)"></i>
                    <input type="text" id="search-input" class="neu-input" style="padding-left: 36px;" placeholder="æœå°‹åç¨±ã€ä»£è™Ÿ..." oninput="app.renderInventory()">
                </div>
                
                <div class="form-grid-3" style="margin-bottom:12px;">
                    <select id="filter-main-cat" class="neu-select" style="margin:0;" onchange="app.onMainFilterChange()"></select>
                    <select id="filter-sub-cat" class="neu-select" style="margin:0;" onchange="app.renderInventory()">
                        <option value="">æ‰€æœ‰å°é¡</option>
                    </select>
                    <label class="neu-btn sm" style="justify-content:center; background:white; border:var(--border-subtle); color:var(--text-main); margin:0; height:48px; display:flex; align-items:center;">
                        <input type="checkbox" id="filter-low-stock" onchange="app.renderInventory()" style="margin-right:8px;"> ç¼ºè²¨
                    </label>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin: 15px 0;">
                <button class="neu-btn success" onclick="app.openItemModal()"><i class="ph ph-camera-plus"></i> æ–°å¢åŒ…è£</button>
            </div>
            <div id="inventory-list-container"></div>
        </div>

        <div id="view-movement" class="view-section hidden">
            <div class="neu-card" style="height: auto;">
                <h2 style="color: var(--primary); margin-top:0;"><i class="ph ph-note-pencil"></i> é€²å‡ºç´€éŒ„</h2>
                <form onsubmit="app.submitMovement(event)">
                    <label>é¡å‹</label>
                    <div style="display:flex; gap: 8px; margin-bottom:15px;">
                        <button type="button" class="neu-btn type-btn active" data-type="in" onclick="app.setMoveType('in')">é€²åº«</button>
                        <button type="button" class="neu-btn type-btn" data-type="out" onclick="app.setMoveType('out')">é ˜å‡º</button>
                        <button type="button" class="neu-btn type-btn" data-type="adj" onclick="app.setMoveType('adj')">ç›¤é»</button>
                    </div>
                    <input type="hidden" id="move-type" value="in">
                    
                    <div class="form-grid">
                        <div>
                            <label>ç¯©é¸å¤§é¡</label>
                            <select id="move-filter-main-cat" class="neu-select" onchange="app.onMoveMainFilterChange()">
                                <option value="">å…¨éƒ¨å¤§é¡</option>
                            </select>
                        </div>
                        <div>
                            <label>ç¯©é¸å°é¡</label>
                            <select id="move-filter-sub-cat" class="neu-select" onchange="app.renderMoveSelect()">
                                <option value="">å…¨éƒ¨å°é¡</option>
                            </select>
                        </div>
                    </div>

                    <label>åŒ…è£ç›’</label>
                    <select id="move-item-id" class="neu-select" required onchange="app.updateMoveStockHint()"><option value="">é¸æ“‡...</option></select>
                    <div id="move-stock-hint" style="font-size:0.85rem; color:var(--primary); text-align:right; margin-bottom:12px;"></div>
                    
                    <label id="lbl-qty">æ•¸é‡</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="move-qty" class="neu-input" required placeholder="è¼¸å…¥æ•´æ•¸" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    
                    <div class="form-grid">
                        <div><label>æ™‚é–“</label><input type="datetime-local" id="move-time" class="neu-input" required></div>
                        <div><label>ç¶“æ‰‹äºº</label><input type="text" id="move-handler" class="neu-input"></div>
                    </div>
                    
                    <label>å‚™è¨»</label>
                    <input type="text" id="move-reason" class="neu-input" placeholder="ä¾‹ï¼šæ¡è³¼...">
                    <button type="submit" class="neu-btn success" style="width:100%; margin-top:15px; padding:12px;">ç¢ºèªé€å‡º</button>
                </form>
            </div>
        </div>

        <div id="view-history" class="view-section hidden">
            <div class="neu-card" style="height: auto;">
                <div class="form-grid">
                    <div><label>é–‹å§‹</label><input type="date" id="hist-start" class="neu-input" onchange="app.renderHistory()"></div>
                    <div><label>çµæŸ</label><input type="date" id="hist-end" class="neu-input" onchange="app.renderHistory()"></div>
                </div>
                <input type="text" id="hist-search" class="neu-input" placeholder="æœå°‹é—œéµå­—..." oninput="app.renderHistory()" style="margin-top:10px;">
            </div>
            <div id="history-list" style="margin-top:20px;"></div>
        </div>

        <div id="view-settings" class="view-section hidden">
            <div class="neu-card" style="height: auto;">
                <h2 style="color: var(--primary); margin-top:0;"><i class="ph ph-tag"></i> åˆ†é¡èˆ‡ç³»çµ±ç®¡ç†</h2>
                
                <div class="neu-card" style="background:#F8F9FA; border:none; padding:15px; margin-bottom:15px;">
                    <h3 style="margin:0 0 10px 0; font-size:1rem;">ç³»çµ±åç¨±è¨­å®š</h3>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="setting-app-title" class="neu-input" placeholder="ä¾‹ï¼šæå®¶èŒ¶è‘‰å€‰åº«" style="margin:0;">
                        <button class="neu-btn success" onclick="app.saveAppTitle()"><i class="ph ph-floppy-disk"></i></button>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-light); margin-top:5px;">ä¿®æ”¹å¾Œï¼Œæ‰€æœ‰åŒæ­¥è£ç½®å°‡ç«‹å³æ›´æ–°ã€‚</p>
                </div>
                
                <div class="neu-card" style="background:#F8F9FA; border:none; padding:15px; margin-bottom:15px;">
                    <h3 style="margin:0 0 10px 0; font-size:1rem;">è³‡æ–™å‚™ä»½</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="neu-btn" onclick="app.exportData()" style="flex:1;"><i class="ph ph-download-simple"></i> åŒ¯å‡ºå‚™ä»½</button>
                        <button class="neu-btn" onclick="document.getElementById('file-import').click()" style="flex:1;"><i class="ph ph-upload-simple"></i> åŒ¯å…¥å‚™ä»½</button>
                        <input type="file" id="file-import" accept=".json" style="display:none" onchange="app.importData(this)">
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-light); margin-top:5px;">åŒ¯å‡ºå¯ä¿å­˜ç›®å‰é›²ç«¯æ‰€æœ‰è³‡æ–™ï¼›åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚</p>
                </div>

                <div class="neu-card" style="background:#F8F9FA; border:none; padding:15px; margin-bottom:15px;">
                    <h3 style="margin:0 0 10px 0; font-size:1rem;">å¤§é¡</h3>
                    <div id="settings-main-cat-list" style="margin-bottom:10px;"></div>
                    <div style="display:flex; gap:8px;"><input type="text" id="new-main-cat" class="neu-input" placeholder="åç¨±" style="margin:0;"><button class="neu-btn success" onclick="app.addMainCat()">+</button></div>
                </div>
                <div class="neu-card" style="background:#F8F9FA; border:none; padding:15px;">
                    <h3 style="margin:0 0 10px 0; font-size:1rem;">å°é¡</h3>
                    <select id="settings-sub-cat-parent" class="neu-select" style="margin-bottom:10px;"><option value="">å…ˆé¸å¤§é¡...</option></select>
                    <div id="settings-sub-cat-list" style="margin-bottom:10px;"></div>
                    <div style="display:flex; gap:8px;"><input type="text" id="new-sub-cat" class="neu-input" placeholder="åç¨±" style="margin:0;"><button class="neu-btn success" onclick="app.addSubCat()">+</button></div>
                </div>
            </div>
            <div class="neu-card" style="border-color:var(--danger); height:auto; margin-top:20px;">
                <button class="neu-btn danger" style="width:100%;" onclick="app.clearAllData()"><i class="ph ph-trash"></i> åˆªé™¤æ‰€æœ‰é›²ç«¯è³‡æ–™ (å±éšª)</button>
            </div>
        </div>
    </main>
</div>

<div class="fab-scan" onclick="app.openScanner()"><i class="ph ph-scan"></i></div>

<div id="modal-scanner" class="modal-overlay">
    <div class="neu-card modal-content" style="text-align:center; height:auto;">
        <h3>æƒææ¢ç¢¼</h3>
        <div id="reader" style="width:100%; border-radius:12px; overflow:hidden;"></div>
        <button class="neu-btn danger" onclick="app.closeScanner()" style="margin-top:15px;">é—œé–‰</button>
    </div>
</div>

<div id="modal-item" class="modal-overlay">
    <div class="neu-card modal-content">
        <h2 id="modal-item-title" style="color:var(--primary); margin-top:0;">æ–°å¢åŒ…è£</h2>
        <form onsubmit="app.saveItem(event)">
            <input type="hidden" id="item-id">
            <label>åœ–ç‰‡ (é»æ“Šä¸Šå‚³)</label>
            <div class="image-preview-box" onclick="document.getElementById('item-image-file').click()">
                <div class="placeholder" style="text-align:center; color:var(--text-light)"><i class="ph ph-camera" style="font-size:2rem;"></i><br><span>é¸æ“‡ç…§ç‰‡</span></div>
                <img id="item-image-preview" src="">
                <input type="file" id="item-image-file" accept="image/*" onchange="app.handleImageUpload(this)">
                <input type="hidden" id="item-image-base64">
            </div>
            <label>åç¨± *</label><input type="text" id="item-name" class="neu-input" required>
            <label>æ¢ç¢¼</label><input type="text" id="item-code" class="neu-input" placeholder="æƒæç”¨">
            <div class="form-grid">
                <div><label>å¤§é¡ *</label><select id="item-main-cat" class="neu-select" required onchange="app.renderSubCatOptionsInModal()"></select></div>
                <div><label>å°é¡</label><select id="item-sub-cat" class="neu-select"></select></div>
            </div>
            <div class="form-grid">
                <div><label>å®‰å…¨åº«å­˜</label><input type="text" inputmode="numeric" pattern="[0-9]*" id="item-safety" class="neu-input" value="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');"></div>
                <div><label>æ¨™ç±¤</label><input type="text" id="item-tags" class="neu-input"></div>
            </div>
            <label>å‚™è¨»</label><textarea id="item-notes" class="neu-textarea" rows="2"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button type="button" class="neu-btn" onclick="app.closeModals()">å–æ¶ˆ</button>
                <button type="submit" class="neu-btn success">å„²å­˜</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-detail" class="modal-overlay">
    <div class="neu-card modal-content">
        <div style="display:flex; justify-content:space-between;"><h2 id="detail-title" style="color:var(--primary); margin:0;"></h2><button class="neu-btn sm" onclick="app.closeModals()" style="background:none;">âœ•</button></div>
        <div id="detail-image-container" style="text-align:center; margin:15px 0; display:none;"><img id="detail-image" src="" style="max-width:100%; max-height:250px; border-radius:12px;"></div>
        <div id="detail-stats" style="margin-bottom:20px; padding:15px; background:var(--bg-app); border-radius:var(--radius-md); font-size:0.9rem;"></div>
        <h3>è¿‘æœŸç´€éŒ„</h3><div id="detail-ledger" style="max-height:250px; overflow-y:auto;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:20px; padding-top:15px; border-top:1px solid #eee;">
             <button class="neu-btn danger sm" id="btn-delete-item"><i class="ph ph-trash"></i> åˆªé™¤</button>
             <button class="neu-btn sm" id="btn-edit-item" style="background:var(--primary-soft);"><i class="ph ph-pencil-simple"></i> ä¿®æ”¹</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB8QiVjk-PRxre7xlt389vs0Hf5aBiAXrg",
    authDomain: "my-erp-system-6521c.firebaseapp.com",
    projectId: "my-erp-system-6521c",
    storageBucket: "my-erp-system-6521c.firebasestorage.app",
    messagingSenderId: "374424194868",
    appId: "1:374424194868:web:521879509c985ca0dd1f61",
    measurementId: "G-EQDX9HSNMX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  window.db = db;
  window.doc = doc;
  window.onSnapshot = onSnapshot;
  window.setDoc = setDoc;
  
  window.dispatchEvent(new Event('firebase-ready'));
</script>

<script>
    const App = function() {
        this.data = { items: [], movements: [], categories: { main: [], sub: [] }, settings: { appTitle: "å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)" } };
        this.docRef = null; 
        this.html5QrcodeScanner = null;
        this.unsubscribe = null;

        this.init = () => {
            if (window.db) { this.setupRealtimeSync(); } 
            else { window.addEventListener('firebase-ready', () => this.setupRealtimeSync()); }
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('move-time').value = now.toISOString().slice(0, 16);
        };

        // --- REAL-TIME SYNC ---
        this.setupRealtimeSync = () => {
            console.log("Connecting...");
            this.docRef = window.doc(window.db, "inventory", "main_data");

            this.unsubscribe = window.onSnapshot(this.docRef, (docSnap) => {
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(()=>document.getElementById('loading-overlay').style.display='none', 300);

                if (docSnap.exists()) {
                    console.log("Data sync");
                    const cloudData = docSnap.data();
                    this.data = {
                        items: cloudData.items || [],
                        movements: cloudData.movements || [],
                        categories: cloudData.categories || { main:[], sub:[] },
                        settings: cloudData.settings || { appTitle: "å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)" }
                    };
                    this.renderAll();
                } else {
                    console.log("Init creation");
                    this.seedDemoData(); 
                }
            }, (error) => {
                alert("é€£ç·šéŒ¯èª¤ï¼šè«‹æª¢æŸ¥ Firebase è¨­å®šã€‚");
                document.getElementById('loading-overlay').style.display='none';
            });
        };

        this.saveData = async () => {
            try { await window.setDoc(this.docRef, this.data); console.log("Saved"); } 
            catch (e) { alert("å„²å­˜å¤±æ•—ï¼š"+e.message); }
        };

        // --- EXPORT / IMPORT FUNCTIONS ---
        this.exportData = () => {
            const dataStr = JSON.stringify(this.data);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'warehouse_backup_'+new Date().toISOString().slice(0,10)+'.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        this.importData = (input) => {
            const file = input.files[0];
            if(!file) return;
            if(!confirm("âš ï¸ è­¦å‘Šï¼šåŒ¯å…¥å°‡æœƒå®Œå…¨è¦†è“‹ç›®å‰çš„é›²ç«¯è³‡æ–™ï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) { input.value = ''; return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if(loadedData.items && loadedData.movements && loadedData.categories) {
                        this.data = loadedData; this.saveData(); alert("âœ… åŒ¯å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚"); location.reload();
                    } else { alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘å¿…è¦è³‡æ–™æ¬„ä½ã€‚"); }
                } catch(err) { alert("âŒ è®€å–å¤±æ•—ï¼š" + err.message); }
                input.value = '';
            };
            reader.readAsText(file);
        };

        this.renderAppTitle = () => {
            const title = (this.data.settings && this.data.settings.appTitle) ? this.data.settings.appTitle : "å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)";
            document.getElementById('header-title-text').textContent = title;
            document.title = title;
            const navTitle = document.getElementById('nav-title-text');
            if(navTitle) navTitle.innerHTML = `ğŸ“¦ ${title}`;
            document.getElementById('setting-app-title').value = title;
        };

        this.saveAppTitle = () => {
            const val = document.getElementById('setting-app-title').value.trim();
            if(val) {
                if(!this.data.settings) this.data.settings = {};
                this.data.settings.appTitle = val;
                this.saveData();
                alert("âœ… åç¨±å·²æ›´æ–°ä¸¦åŒæ­¥è‡³æ‰€æœ‰è£ç½®");
            }
        };

        this.seedDemoData = () => {
            const teaId = 'c1', boxId = 'c2';
            this.data.categories.main = [{id:teaId, name:'èŒ¶ç¦®ç›’'}, {id:boxId, name:'å¤–ç®±'}];
            this.data.categories.sub = [{id:'s1', parentId:teaId, name:'å››å…©'}];
            this.data.items = [
                { id: 'i1', name: 'ç´…ç‰å››å…©ç›’', code: '4711234567890', mainCatId: teaId, subCatId: 's1', tags: 'ç†±éŠ·', safetyStock: 30, notes: '', image: '' }
            ];
            this.data.movements = [{ id: 'm1', itemId: 'i1', type: 'in', qty: 100, time: new Date().toISOString(), handler: 'åˆå§‹', reason: '', isVoid: false }];
            this.saveData(); 
        };

        this.getStock = (itemId) => {
            return this.data.movements.reduce((acc, m) => {
                if (m.itemId !== itemId || m.isVoid) return acc;
                return acc + (m.type === 'in' ? m.qty : (m.type === 'out' ? -m.qty : m.qty));
            }, 0);
        };
        this.getItem = (id) => this.data.items.find(i => i.id === id);
        this.getMainCatName = (id) => (this.data.categories.main.find(x=>x.id==id) || {}).name || 'æœªåˆ†é¡';
        this.getSubCatName = (id) => (this.data.categories.sub.find(x=>x.id==id) || {}).name || '';

        this.handleImageUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_W = 600; 
                    const scale = MAX_W / img.width;
                    const w = (img.width > MAX_W) ? MAX_W : img.width;
                    const h = (img.width > MAX_W) ? img.height * scale : img.height;
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                    document.getElementById('item-image-preview').src = dataUrl;
                    document.querySelector('.image-preview-box').classList.add('has-image');
                    document.getElementById('item-image-base64').value = dataUrl;
                };
            };
        };

        this.renderAll = () => {
            this.renderAppTitle();
            this.renderInventory(); 
            this.renderMoveFilterOptions(); // åˆå§‹åŒ–ç§»å‹•é é¢ç¯©é¸
            this.renderMoveSelect(); 
            this.renderHistory(); 
            this.renderSettings();
        };
        this.switchTab = (tabId, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(tabId === 'view-inventory') this.renderInventory();
            window.scrollTo(0,0);
        };

        // Inventory
        this.renderInventory = () => {
            const container = document.getElementById('inventory-list-container');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterMain = document.getElementById('filter-main-cat').value;
            const filterSub = document.getElementById('filter-sub-cat').value; 
            const onlyLow = document.getElementById('filter-low-stock').checked;
            container.innerHTML = '';
            
            const grouped = {};
            this.data.categories.main.forEach(c => grouped[c.id] = {name:c.name, items:[]});
            grouped['uncat'] = {name:'æœªåˆ†é¡', items:[]};

            this.data.items.forEach(item => {
                const stock = this.getStock(item.id);
                const isLow = item.safetyStock > 0 && stock <= item.safetyStock;
                
                if (onlyLow && !isLow) return;
                if (filterMain && item.mainCatId !== filterMain) return;
                if (filterSub && item.subCatId !== filterSub) return;
                if (search && !(item.name+item.code+item.tags).toLowerCase().includes(search)) return;
                
                const k = (item.mainCatId && grouped[item.mainCatId]) ? item.mainCatId : 'uncat';
                grouped[k].items.push({...item, stock, isLow});
            });

            Object.keys(grouped).forEach(k => {
                if (grouped[k].items.length === 0) return;
                container.innerHTML += `<div class="category-header"><span>${grouped[k].name}</span><span style="font-weight:normal; font-size:0.8rem; color:var(--text-light)">${grouped[k].items.length}</span></div>`;
                grouped[k].items.sort((a,b)=>a.name.localeCompare(b.name)).forEach(i => {
                    const sub = this.getSubCatName(i.subCatId);
                    const imgHtml = i.image ? `<img src="${i.image}" class="item-thumb" loading="lazy">` : `<div class="item-thumb-placeholder"><i class="ph ph-package"></i></div>`;
                    container.innerHTML += `
                    <div class="neu-card item-row ${i.isLow?'low-stock-row':''}" onclick="app.openDetail('${i.id}')">
                        <div class="item-info-container">
                            ${imgHtml}
                            <div class="item-info">
                                <h3>${i.name} <span style="font-size:0.8rem;color:var(--primary)">${sub?'Â· '+sub:''}</span></h3>
                                <div style="font-size:0.85rem; color:var(--text-light)">${i.code?`<i class="ph ph-barcode"></i> ${i.code} | `:''}å®‰å…¨: ${i.safetyStock}</div>
                            </div>
                        </div>
                        <div class="item-stock-container">
                            <span class="stock-number">${i.stock}</span>
                            <span class="badge ${i.isLow?'low-stock':'normal'}">${i.isLow?'è£œè²¨':'æ­£å¸¸'}</span>
                        </div>
                    </div>`;
                });
            });
        };

        this.onMainFilterChange = () => {
            const mainId = document.getElementById('filter-main-cat').value;
            const subSel = document.getElementById('filter-sub-cat');
            subSel.innerHTML = '<option value="">æ‰€æœ‰å°é¡</option>';
            if(mainId) {
                const subs = this.data.categories.sub.filter(s => s.parentId === mainId);
                subs.forEach(s => {
                    subSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            }
            this.renderInventory();
        };

        // Movement
        this.setMoveType = (t) => {
            document.getElementById('move-type').value = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.type-btn[data-type="${t}"]`).classList.add('active');
            const qtyLabel = document.getElementById('lbl-qty');
            if(t==='adj') { qtyLabel.innerHTML="ç›¤é»å¾Œæ­£ç¢ºæ•¸é‡"; qtyLabel.style.color="var(--warning)"; } 
            else { qtyLabel.innerHTML="æ•¸é‡"; qtyLabel.style.color="var(--text-main)"; }
        };

        // æ–°å¢ï¼šæ¸²æŸ“ç§»å‹•é é¢çš„å¤§é¡ç¯©é¸å™¨
        this.renderMoveFilterOptions = () => {
            const sel = document.getElementById('move-filter-main-cat');
            const curr = sel.value;
            sel.innerHTML = '<option value="">å…¨éƒ¨å¤§é¡</option>';
            this.data.categories.main.forEach(c => {
                sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            sel.value = curr;
        };

        // æ–°å¢ï¼šç•¶å¤§é¡æ”¹è®Šæ™‚ï¼Œæ›´æ–°å°é¡é¸å–®
        this.onMoveMainFilterChange = () => {
            const mainId = document.getElementById('move-filter-main-cat').value;
            const subSel = document.getElementById('move-filter-sub-cat');
            subSel.innerHTML = '<option value="">å…¨éƒ¨å°é¡</option>';

            if (mainId) {
                const subs = this.data.categories.sub.filter(s => s.parentId === mainId);
                subs.forEach(s => {
                    subSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            }
            // é‡ç½®å¾Œé‡æ–°æ¸²æŸ“ç”¢å“
            this.renderMoveSelect();
        };

        // ä¿®æ”¹ï¼šæ ¹æ“šé›™é‡ç¯©é¸å™¨æ¸²æŸ“ç”¢å“åˆ—è¡¨
        this.renderMoveSelect = () => {
            const filterMainId = document.getElementById('move-filter-main-cat').value;
            const filterSubId = document.getElementById('move-filter-sub-cat').value;
            const sel = document.getElementById('move-item-id');
            const curr = sel.value; 
            sel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            
            let items = this.data.items;
            
            // ç¯©é¸é‚è¼¯
            if(filterMainId) {
                items = items.filter(i => i.mainCatId === filterMainId);
            }
            if(filterSubId) {
                items = items.filter(i => i.subCatId === filterSubId);
            }

            items.sort((a,b) => (this.getMainCatName(a.mainCatId)+a.name).localeCompare(this.getMainCatName(b.mainCatId)+b.name))
                .forEach(i => sel.innerHTML += `<option value="${i.id}" data-stock="${this.getStock(i.id)}">[${this.getMainCatName(i.mainCatId)}] ${i.name}</option>`);
            
            if(Array.from(sel.options).some(o => o.value === curr)) {
                sel.value = curr;
            } else {
                sel.value = "";
                this.updateMoveStockHint();
            }
        };

        this.updateMoveStockHint = () => {
            const opt = document.getElementById('move-item-id').selectedOptions[0];
            document.getElementById('move-stock-hint').textContent = opt && opt.value ? `åº«å­˜: ${opt.dataset.stock}` : '';
        };
        this.submitMovement = (e) => {
            e.preventDefault();
            const type = document.getElementById('move-type').value;
            const itemId = document.getElementById('move-item-id').value;
            const qtyVal = document.getElementById('move-qty').value;
            const qty = parseInt(qtyVal);
            const stock = this.getStock(itemId);
            const reason = document.getElementById('move-reason').value;
            
            if (!itemId || isNaN(qty) || qty < 0) return alert('è«‹å¡«å¯«æ­£ç¢º');
            
            let finalQty = qty, finalReason = reason;
            if (type === 'out' && stock < qty) return alert('åº«å­˜ä¸è¶³');
            if (type === 'adj') {
                const diff = qty - stock;
                if(diff === 0) return alert('åº«å­˜ç„¡è®Šå‹•');
                finalQty = diff; finalReason = `ç›¤é»ä¿®æ­£ (${stock}â”${qty}) ` + reason;
            }
            this.data.movements.push({id:'m_'+Date.now(), itemId, type, qty:finalQty, time:document.getElementById('move-time').value, handler:document.getElementById('move-handler').value, reason:finalReason, isVoid:false});
            this.saveData(); alert('å·²å„²å­˜'); e.target.reset(); this.setMoveType('in');
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('move-time').value = now.toISOString().slice(0, 16);
            
            // é‡ç½®ç¯©é¸ï¼ˆå¯é¸ï¼Œé€™è£¡ä¿ç•™ä»¥æ–¹ä¾¿é€£çºŒæ“ä½œåŒé¡ç”¢å“ï¼‰
            // this.renderMoveFilterOptions();
            // this.onMoveMainFilterChange();
        };

        // History
        this.renderHistory = () => {
            const container = document.getElementById('history-list');
            const start = document.getElementById('hist-start').value, end = document.getElementById('hist-end').value, search = document.getElementById('hist-search').value.toLowerCase();
            container.innerHTML = '';
            const filtered = this.data.movements.filter(m => {
                if (start && m.time.substring(0,10) < start) return false;
                if (end && m.time.substring(0,10) > end) return false;
                const item = this.getItem(m.itemId);
                return !search || (m.reason+m.handler+(item?item.name:'')).toLowerCase().includes(search);
            }).sort((a,b) => new Date(b.time) - new Date(a.time));
            if(filtered.length === 0) container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light)">ç„¡ç´€éŒ„</div>';
            filtered.forEach(m => {
                const item = this.getItem(m.itemId);
                let color = 'var(--text-main)', icon = 'ph-info', sign = '';
                if(m.type==='in'){color='var(--success)'; icon='ph-arrow-down'; sign='+';}
                if(m.type==='out'){color='var(--danger)'; icon='ph-arrow-up'; sign='-';}
                if(m.type==='adj'){color='var(--warning)'; icon='ph-wrench'; sign=(m.qty>=0?'+':'');}
                container.innerHTML += `
                <div class="neu-card history-item type-${m.type} ${m.isVoid?'voided':''}" style="height:auto;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between">
                        <div>
                            <b>${item?item.name:'?'}</b> ${m.isVoid?'<span class="badge void">æ’¤éŠ·</span>':''}
                            <div style="font-size:0.8rem;color:var(--text-light);">${m.time.substring(5,16).replace('T',' ')} | ${m.handler||'-'}</div>
                            <div style="font-size:0.9rem;">${m.reason||''}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:1.3rem;font-weight:bold;color:${color}"><i class="ph ${icon}"></i> ${sign}${Math.abs(m.qty)}</div>
                            ${!m.isVoid ? `<button class="neu-btn sm danger" style="margin-top:5px;" onclick="app.voidMove('${m.id}')">æ’¤éŠ·</button>`:''}
                        </div>
                    </div>
                </div>`;
            });
        };
        this.voidMove = (id) => { if(confirm('ç¢ºå®šæ’¤éŠ·ï¼Ÿ')) { const m=this.data.movements.find(x=>x.id===id); if(m){m.isVoid=true; this.saveData();} } };

        // Settings & CRUD
        this.renderSettings = () => {
            document.getElementById('settings-main-cat-list').innerHTML = this.data.categories.main.map(c=>`<div class="edit-chip"><span class="edit-chip-name" onclick="app.editMainCat('${c.id}')">${c.name}</span><span class="edit-chip-del" onclick="app.delMain('${c.id}')">âœ•</span></div>`).join('');
            
            // Populate Sub Cat Settings
            const pSel = document.getElementById('settings-sub-cat-parent'); 
            const pVal = pSel.value;
            pSel.innerHTML = '<option value="">å…ˆé¸å¤§é¡...</option>'+this.data.categories.main.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            pSel.value = pVal;

            // Populate Inventory Main Filter
            const fSel = document.getElementById('filter-main-cat');
            const fVal = fSel.value;
            fSel.innerHTML = '<option value="">æ‰€æœ‰å¤§é¡</option>'+this.data.categories.main.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            fSel.value = fVal;

            this.renderSubSettings();
        };
        this.renderSubSettings = () => {
            const pid = document.getElementById('settings-sub-cat-parent').value;
            const subs = this.data.categories.sub.filter(s=>s.parentId===pid);
            document.getElementById('settings-sub-cat-list').innerHTML = subs.map(s=>`<div class="edit-chip"><span class="edit-chip-name" onclick="app.editSubCat('${s.id}')">${s.name}</span><span class="edit-chip-del" onclick="app.delSub('${s.id}')">âœ•</span></div>`).join('');
        };
        document.getElementById('settings-sub-cat-parent').onchange = () => app.renderSubSettings();
        
        this.addMainCat=()=>{const n=document.getElementById('new-main-cat').value; if(n){this.data.categories.main.push({id:'mc'+Date.now(),name:n}); document.getElementById('new-main-cat').value=''; this.saveData();}};
        this.editMainCat=(id)=>{const c=this.data.categories.main.find(x=>x.id==id);const n=prompt('ä¿®æ”¹',c.name);if(n){c.name=n;this.saveData();}};
        this.delMain=(id)=>{if(confirm('ç¢ºå®šï¼Ÿ')){this.data.categories.main=this.data.categories.main.filter(x=>x.id!==id);this.saveData();}};
        this.addSubCat=()=>{const p=document.getElementById('settings-sub-cat-parent').value, n=document.getElementById('new-sub-cat').value; if(p&&n){this.data.categories.sub.push({id:'sc'+Date.now(),parentId:p,name:n}); document.getElementById('new-sub-cat').value=''; this.saveData();}};
        this.editSubCat=(id)=>{const c=this.data.categories.sub.find(x=>x.id==id);const n=prompt('ä¿®æ”¹',c.name);if(n){c.name=n;this.saveData();}};
        this.delSub=(id)=>{if(confirm('ç¢ºå®šï¼Ÿ')){this.data.categories.sub=this.data.categories.sub.filter(x=>x.id!==id);this.saveData();}};
        this.clearAllData=()=>{if(confirm('è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºé›²ç«¯è³‡æ–™åº«ï¼')){this.data={items:[],movements:[],categories:{main:[],sub:[]},settings:{appTitle:"å€‰åº«ç®¡ç† (é›²ç«¯ç‰ˆ)"}};this.saveData();}};

        this.openItemModal = (id=null) => {
            document.getElementById('modal-item').classList.add('open');
            document.getElementById('item-main-cat').innerHTML = '<option value="">é¸...</option>'+this.data.categories.main.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            const imgBox = document.querySelector('.image-preview-box');
            if(id) {
                const i = this.getItem(id);
                document.getElementById('modal-item-title').innerText="ä¿®æ”¹åŒ…è£";
                document.getElementById('item-id').value=i.id; document.getElementById('item-name').value=i.name; document.getElementById('item-code').value=i.code||'';
                document.getElementById('item-main-cat').value=i.mainCatId; this.renderSubCatOptionsInModal(); document.getElementById('item-sub-cat').value=i.subCatId;
                document.getElementById('item-safety').value=i.safetyStock; document.getElementById('item-tags').value=i.tags; document.getElementById('item-notes').value=i.notes;
                document.getElementById('item-image-base64').value=i.image||'';
                document.getElementById('item-image-preview').src=i.image||'';
                if(i.image) imgBox.classList.add('has-image'); else imgBox.classList.remove('has-image');
            } else {
                document.getElementById('modal-item-title').innerText="æ–°å¢åŒ…è£"; document.getElementById('item-id').value=''; document.querySelector('#modal-item form').reset();
                imgBox.classList.remove('has-image');
            }
        };
        this.renderSubCatOptionsInModal = () => {
            const pid = document.getElementById('item-main-cat').value;
            document.getElementById('item-sub-cat').innerHTML = '<option value="">ç„¡</option>' + this.data.categories.sub.filter(s=>s.parentId===pid).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        };
        this.saveItem = (e) => {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const obj = {
                id: id?id:'i_'+Date.now(), name:document.getElementById('item-name').value, code:document.getElementById('item-code').value,
                mainCatId:document.getElementById('item-main-cat').value, subCatId:document.getElementById('item-sub-cat').value,
                safetyStock:document.getElementById('item-safety').value, tags:document.getElementById('item-tags').value,
                notes:document.getElementById('item-notes').value, image:document.getElementById('item-image-base64').value
            };
            if(id){ const idx=this.data.items.findIndex(x=>x.id===id); if(idx!==-1)this.data.items[idx]=obj; }
            else { this.data.items.push(obj); }
            this.saveData(); this.closeModals();
        };
        this.deleteItem = (id) => {
            if(confirm('åˆªé™¤åŒ…è£æœƒé€£åŒæ­·å²ç´€éŒ„ä¸€ä½µåˆªé™¤ï¼Œç¢ºå®šï¼Ÿ')){
                this.data.items = this.data.items.filter(i=>i.id!==id);
                this.data.movements = this.data.movements.filter(m=>m.itemId!==id);
                this.saveData(); this.closeModals();
            }
        };

        this.openDetail = (id) => {
            const item = this.getItem(id);
            document.getElementById('modal-detail').classList.add('open');
            document.getElementById('detail-title').innerText = item.name;
            const imgContainer = document.getElementById('detail-image-container');
            if(item.image) { document.getElementById('detail-image').src = item.image; imgContainer.style.display='block'; } else imgContainer.style.display='none';
            let bal = 0, html = '<table style="width:100%;font-size:0.9rem"><tr><td>æ™‚é–“</td><td>å‹•ä½œ</td><td align="right">è®Š</td><td align="right">é¤˜</td></tr>';
            this.data.movements.filter(m=>m.itemId===id && !m.isVoid).sort((a,b)=>new Date(a.time)-new Date(b.time)).forEach(m=>{
                const chg = m.type==='in'?m.qty:(m.type==='out'?-m.qty:m.qty); bal+=chg;
                html+=`<tr><td style="border-top:1px solid #eee;padding:8px 0">${m.time.substring(5,16).replace('T',' ')}</td><td>${m.type}</td><td align="right" style="color:${chg>0?'green':'red'}">${chg>0?'+'+chg:chg}</td><td align="right"><b>${bal}</b></td></tr>`;
            });
            document.getElementById('detail-ledger').innerHTML=html+'</table>';
            document.getElementById('detail-stats').innerHTML=`æ¢ç¢¼: ${item.code||'--'}<br>åº«å­˜: ${bal} / å®‰å…¨: ${item.safetyStock}<br>åˆ†é¡: ${this.getMainCatName(item.mainCatId)}`;
            
            document.getElementById('btn-delete-item').onclick = () => app.deleteItem(id);
            document.getElementById('btn-edit-item').onclick = () => { app.closeModals(); setTimeout(()=>app.openItemModal(id),200); };
        };

        this.openScanner=()=>{document.getElementById('modal-scanner').classList.add('open');if(!this.html5QrcodeScanner){this.html5QrcodeScanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250,videoConstraints:{facingMode:"environment"}});this.html5QrcodeScanner.render((txt)=>{const item=this.data.items.find(i=>i.code===txt);if(item){this.closeScanner();this.switchTab('view-movement',document.getElementById('nav-move'));const sel=document.getElementById('move-item-id');sel.value=item.id;this.updateMoveStockHint();setTimeout(()=>{alert(`å·²æƒæï¼š${item.name}\nåº«å­˜ï¼š${this.getStock(item.id)}`);document.getElementById('move-qty').focus();},300);}else{this.html5QrcodeScanner.pause();alert('æ‰¾ä¸åˆ°æ¢ç¢¼ï¼š'+txt);this.html5QrcodeScanner.resume();}},(err)=>{});}};
        this.closeScanner=()=>{document.getElementById('modal-scanner').classList.remove('open');if(this.html5QrcodeScanner){this.html5QrcodeScanner.clear().then(_=>{this.html5QrcodeScanner=null;document.getElementById('reader').innerHTML="";}).catch(e=>{});}};
        this.closeModals=()=>{document.querySelectorAll('.modal-overlay').forEach(el=>el.classList.remove('open'));this.closeScanner();};
    };

    const app = new App();
    window.onload = () => app.init();
    document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) app.closeModals(); }));
</script>
</body>
</html>
